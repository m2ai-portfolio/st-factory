# Snow-Town Session Recap

## Use this prompt to continue the project

---

### What Snow-Town Is

Snow-Town is a closed-loop learning ecosystem that wires three existing projects into a feedback triangle:

```
Ultra Magnus ──OutcomeRecord──> Sky-Lynx
     ^                              │
     │                    ImprovementRecommendation
PersonaUpgradePatch                 │
     │                              v
     └──────────── Agent Persona Academy
```

- **Ultra Magnus** (idea pipeline) runs ideas through capture → enrichment → evaluation → review → scaffold → build → publish. When an idea reaches a terminal state, it emits an `OutcomeRecord`.
- **Sky-Lynx** (observer) reads outcome records + weekly usage data, runs Claude analysis, and produces typed `ImprovementRecommendation` objects (each classified by `target_system`: persona, claude_md, or pipeline).
- **Agent Persona Academy** (factory) consumes persona-targeted recommendations. A `persona_upgrader.py` script calls Claude API to generate `PersonaUpgradePatch` objects (JSON Pointer-based YAML diffs), validated against the Academy's persona schema.
- Upgraded personas feed back into Ultra Magnus for the next cycle.

### Key Architectural Choices Made

1. **JSONL as source of truth, SQLite as query layer.** Three append-only JSONL files in `snow-town/data/` are git-tracked. SQLite (`persona_metrics.db`) provides indexed queries but is rebuildable from JSONL via `store.rebuild_sqlite()`. The `.gitignore` excludes `*.db`.

2. **Contracts live in `snow-town/contracts/`, imported via `sys.path`.** All three projects import contracts with `sys.path.insert(0, snow_town_path)`. This works because everything runs on the same EC2 instance. No package publishing needed.

3. **ContractStore dual-writes.** Every `write_outcome()`, `write_recommendation()`, or `write_patch()` call appends to JSONL AND inserts into SQLite in a single operation.

4. **Persona patches default to "proposed" status.** Human review required before applying. `--auto-apply` flag exists for opt-in auto-application of validated patches.

5. **Weekly loop cadence.** `run_loop.sh` orchestrates: Sky-Lynx analyzer → persona upgrader → loop status reporter. Cron config at `snow-town/cron/snow-town` runs Sundays at 2 AM.

6. **Recommendation classification.** Sky-Lynx's `Recommendation` model was extended with `target_system` (persona|claude_md|pipeline), `target_persona` (specific persona ID), and `recommendation_type` (voice_adjustment, framework_addition, etc.). The Claude prompt now requests these fields. The `parse_recommendations()` regex parser was extended (not replaced) to extract them.

7. **Outcome emission hooks in UM.** `repository.py:update_stage()` auto-emits `OutcomeRecord` when stage transitions to PUBLISHED, REJECTED, or DEFERRED. `set_github_url()` also emits for the PUBLISHED path. Deduplication prevents double-emission when both fire for the same idea. A manual `um_record_outcome` MCP tool exists for retroactive recording (14 tools total now).

### What Was Built (by file)

**New repo: `~/projects/snow-town/`**
| File | Purpose |
|------|---------|
| `contracts/outcome_record.py` | OutcomeRecord Pydantic model with PipelineTrace, TerminalOutcome |
| `contracts/improvement_recommendation.py` | ImprovementRecommendation with RecommendationType, TargetScope, EvidenceBasis |
| `contracts/persona_upgrade_patch.py` | PersonaUpgradePatch with PersonaFieldPatch, PatchOperation |
| `contracts/store.py` | ContractStore: dual-write JSONL + SQLite, query methods (incl. `idea_id` filter), rebuild |
| `contracts/__init__.py` | Re-exports all contract types |
| `schemas/*.v1.json` | JSON Schema exports generated from Pydantic models |
| `data/*.jsonl` | Append-only data files (git-tracked) |
| `scripts/persona_upgrader.py` | Reads persona recs, calls Claude API, generates validated YAML patches |
| `scripts/loop_status.py` | Reports feedback loop health: pending counts, oldest items, cycle count |
| `scripts/run_loop.sh` | Orchestrates: SL analyzer → persona upgrader → status report |
| `cron/snow-town` | Cron config for weekly Sunday 2AM execution |
| `tests/test_contracts/` | 33+ tests: schema validation, roundtrip serialization, invariant enforcement, store ops |

**Modified: `~/projects/ultra-magnus/mcp-server/src/ultra_magnus_mcp/`**
| File | Change |
|------|--------|
| `repository.py` | Added snow-town imports, `_emit_outcome_record()` with dedup check, `record_outcome_manual()`, hooks in `update_stage()` and `set_github_url()` |
| `server.py` | Added `um_record_outcome` tool + handler (tool #14) |

**Modified/Created: `~/projects/sky-lynx/src/sky_lynx/`**
| File | Change |
|------|--------|
| `outcome_reader.py` | **NEW** - Reads OutcomeRecords from JSONL, builds digest summaries |
| `claude_client.py` | Extended `Recommendation` with `target_system`, `target_persona`, `recommendation_type`; updated `build_analysis_prompt()` to include outcome digest and request classification; extended `parse_recommendations()` to extract new fields; updated `analyze_insights()` signature |
| `report_writer.py` | Added `write_recommendations_sidecar()` - writes JSON sidecar file + appends to snow-town JSONL store; added `_to_contract_recommendation()` converter |
| `analyzer.py` | Wired `outcome_reader` into `run_analysis()` pipeline |
| `tests/test_report_writer.py` | Added `mock_contract_store` autouse fixture to prevent test side effects |

**Deleted from `~/projects/ultra-magnus/`**
- `idea-factory/` - Legacy FastAPI backend (~80 files)
- `idea-factory-dashboard/` - Superseded vanilla JS dashboard (~16 files)
- `idea-catcher/src/idea_catcher/processor.py` - Dead batch processor

### Current Git State

| Repo | Branch | Remote | Status |
|------|--------|--------|--------|
| `snow-town` | master | `m2ai-portfolio/snow-town` | Fully committed and pushed |
| `ultra-magnus` | develop | `MatthewSnow2/ultra-magnus` | Fully committed and pushed |
| `sky-lynx` | main | `m2ai-portfolio/sky-lynx` | Fully committed and pushed |

### Test State

| Repo | Tests | Status |
|------|-------|--------|
| `snow-town` | 52 tests (contracts + store) | All passing |
| `sky-lynx` | 28 tests (parser, report writer) | All passing, no test side effects |
| `ultra-magnus` | No tests (MCP server) | Imports verified OK, 14 tools load |

### Loop Data State

| Store | Records | Content |
|-------|---------|---------|
| `outcome_records.jsonl` | 3 | Idea #5 published (2x, pre-dedup), Idea #6 deferred |
| `improvement_recommendations.jsonl` | 5 | 2 pipeline, 3 claude_md (from live Sky-Lynx run) |
| `persona_patches.jsonl` | 1 | sky-lynx persona patch (proposed, from prior upgrader run) |

### Known Issues

1. **Cron not installed.** The cron file exists at `snow-town/cron/snow-town` but hasn't been copied to `/etc/cron.d/`. The old Sky-Lynx cron at `/etc/cron.d/sky-lynx` still points to the standalone Sky-Lynx analyzer.

2. **Duplicate OutcomeRecords for idea #5.** The dedup fix was added after idea #5 was processed. The existing 2 duplicate records in `outcome_records.jsonl` remain (harmless but untidy). Future emissions will be deduplicated.

3. **UM still in `MatthewSnow2` org.** Phase 6 rename will consolidate to `m2ai-portfolio`.

---

## Session Log

### 2026-02-07: Initial Build (Phases 0-5)

Built the entire Snow-Town ecosystem from scratch:
- Phase 0: Cleaned dead code from Ultra Magnus
- Phase 1: Created snow-town repo with contracts, store, tests, schemas
- Phase 2: Wired outcome recording into UM's repository.py and server.py
- Phase 3: Extended Sky-Lynx with outcome reader, recommendation classification, JSON sidecar
- Phase 4: Created persona upgrader script
- Phase 5: Created loop orchestrator, status reporter, cron config
- All tests passing (33 snow-town, 28 sky-lynx)
- Snow-town committed (3 commits), UM and SL left uncommitted

### 2026-02-08: Commit, Fix, Prove, Push

**Committed all pending work:**
- UM: 2 commits (legacy cleanup + snow-town integration)
- SL: 2 commits (snow-town integration + test fix)
- All repos pushed to GitHub

**Fixed test side effect:**
- Added `mock_contract_store` autouse fixture in `tests/test_report_writer.py`
- Sky-Lynx tests no longer leak data into production `snow-town/data/` JSONL files
- Verified: full test suite runs cleanly with zero artifacts

**Proved the feedback loop end-to-end:**
- Drove idea #5 (WHEELJACK) through full UM pipeline to PUBLISHED → OutcomeRecord emitted
- Drove idea #6 (Dyson Sphere) to DEFERRED → OutcomeRecord emitted
- Ran Sky-Lynx live (`--no-pr`) → consumed 3 outcome records → produced 4 classified recommendations
- Recommendations correctly tagged: 2 pipeline, 2 claude_md
- Persona upgrader correctly found 0 persona-targeted recommendations and exited
- Full `run_loop.sh --dry-run` completed successfully
- `loop_status.py` reports accurate counts across all 3 stores

**Fixed duplicate OutcomeRecord emission:**
- Added `idea_id` filter to `ContractStore.query_outcomes()`
- Added dedup check in UM's `_emit_outcome_record()` — skips if record already exists
- Prevents double-emission when both `set_github_url()` and `update_stage(PUBLISHED)` fire

**Created snow-town GitHub repo:**
- `m2ai-portfolio/snow-town` (private), master branch, pushed all commits

---

## TODO: What Comes Next

### Activate Automation

- [ ] **Install cron.** `sudo cp ~/projects/snow-town/cron/snow-town /etc/cron.d/ && sudo systemctl restart cron`
- [ ] **Retire old cron.** `sudo rm /etc/cron.d/sky-lynx` (snow-town's run_loop.sh replaces it)
- [ ] **Create log directory + rotation.** `sudo mkdir -p /var/log/snow-town && sudo chown ubuntu:ubuntu /var/log/snow-town` + logrotate config

### Phase 6: Full Rename (Deferred)

- [ ] Decide naming convention (kebab-case? snake_case?)
- [ ] Present full rename map: GitHub repos, directories, package names, internal path references, cron paths, MCP config references
- [ ] Consolidate all repos to `m2ai-portfolio` GitHub org (ultra-magnus currently in MatthewSnow2)
- [ ] Execute renames with `gh repo rename`
- [ ] Update all cross-references (Sky-Lynx hardcodes Academy persona path, etc.)

### Phase 7: Visualization (Deferred)

- [ ] Design dashboard showing items flowing through the loop
- [ ] React app reading from JSONL + SQLite
- [ ] Pipeline status, recommendation queue, patch history, loop health metrics
- [ ] Pure observability - no state mutation

### Hardening

- [ ] Add `--since` flag to `outcome_reader.py` to filter by date range (avoid reprocessing old records)
- [ ] Add deduplication to `write_recommendations_sidecar()` (currently appends every run)
- [ ] Add persona upgrader tests (mock Claude API response)
- [ ] Add integration test: write OutcomeRecord → read in outcome_reader → verify digest format
- [ ] Consider adding `contract_version` migration logic for future schema changes
- [ ] Clean up the 2 duplicate OutcomeRecords for idea #5 in `outcome_records.jsonl`
